FROM php:8.2.20-fpm-alpine3.20 AS base
# ----------------------------------- base stage
ARG REQUIREMENTS
ARG PACKAGES="curl-dev libpng-dev zlib-dev libzip-dev libxml2-dev oniguruma-dev libmcrypt-dev openssl-dev ${REQUIREMENTS}"
ARG PHP_REQUIREMENTS
ARG PHP_EXENSIONS="ctype curl dom fileinfo filter mbstring pdo session xml ${PHP_REQUIREMENTS}"
ARG DOCKER_USERNAME

WORKDIR /app

RUN apk update && \
    apk add --update --no-cache --virtual \
        .packages \
        ${PACKAGES} && \
    docker-php-ext-install -j$(nproc) \
            ${PHP_EXENSIONS} && \
    adduser -s /bin/sh -D ${DOCKER_USERNAME} && \
    rm -rf /tools && \
    apk del .packages && \
    chown -R ${DOCKER_USERNAME}:${DOCKER_USERNAME} /app

COPY /docker/app/php-fpm/www.conf /usr/local/etc/php-fpm.d/www.conf

FROM base AS composer-builder
# ----------------------------------- composer-builder stage
COPY --from=composer /usr/bin/composer /usr/bin/composer
COPY composer.* /app/

RUN if [-f /app/composer.json  ]; then \
        composer install; \
    fi

FROM base AS node-builder
# ----------------------------------- node-builder stage
COPY package.* /app/

RUN apk update && \
    apk add --update --no-cache \
        npm && \
    if [-f /app/package.json  ]; then \
        npm install; \
    fi

FROM base AS production
# ----------------------------------- production stage
COPY --from=composer-builder --chown=${DOCKER_USERNAME}:${DOCKER_USERNAME} /app/vendor /app/vendor
COPY --from=node-builder --chown=${DOCKER_USERNAME}:${DOCKER_USERNAME} /app/node_modules /app/node_modules

COPY --chown=${DOCKER_USERNAME}:${DOCKER_USERNAME}  . /app/

USER ${DOCKER_USERNAME}

CMD [ "php-fpm" ]

FROM base AS development
# ----------------------------------- development stage
ARG DOCKER_USERNAME

COPY --from=composer /usr/bin/composer /usr/bin/composer

RUN apk update && \
    apk add --update --no-cache \
        npm \
        git \
        openssh 

WORKDIR /home/${DOCKER_USERNAME}/tools
ENV PATH=/home/${DOCKER_USERNAME}/tools:${PATH}

COPY --chown=${DOCKER_USERNAME}:${DOCKER_USERNAME} docker/tools/init.sh /home/${DOCKER_USERNAME}/tools/init.sh

USER ${DOCKER_USERNAME}

WORKDIR /app

ENV PATH=/home/${DOCKER_USERNAME}/.composer/vendor/bin:${PATH}
RUN composer global require laravel/installer

CMD [ "php-fpm" ]